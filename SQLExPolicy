{
    "if": {
      "allOf": [
        {
          "field": "type",
          "equals": "Microsoft.Compute/virtualMachines"
        },
        {
          "field": "Microsoft.Compute/imagePublisher",
          "equals": "MicrosoftWindowsServer"
        },
        {
          "field": "Microsoft.Compute/imageOffer",
          "equals": "WindowsServer"
        },
        {
          "field": "Microsoft.Compute/imageSKU",
          "in": [
            "2008-R2-SP1",
            "2008-R2-SP1-smalldisk",
            "2012-Datacenter",
            "2012-Datacenter-smalldisk",
            "2012-R2-Datacenter",
            "2012-R2-Datacenter-smalldisk",
            "2016-Datacenter",
            "2016-Datacenter-Server-Core",
            "2016-Datacenter-Server-Core-smalldisk",
            "2016-Datacenter-smalldisk",
            "2016-Datacenter-with-Containers",
            "2016-Datacenter-with-RDSH"
          ]
        }
      ]
    },
    "then": {
      "effect": "deployIfNotExists",
      "details": {
        "name": "SqlIaasExtension",
        "type": "Microsoft.Compute/virtualMachines/extensions",
        "existenceCondition": {
          "allOf": [
            {
              "field": "Microsoft.Compute/virtualMachines/extensions/type",
              "equals": "SqlIaaSAgent"
            },
            {
              "field": "Microsoft.Compute/virtualMachines/extensions/publisher",
              "equals": "Microsoft.SqlServer.Management"
            }
          ]
        },
        "deployment": {
          "properties": {
            "mode": "incremental",
            "template": {
              "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
              "contentVersion": "1.0.0.0",
              "parameters": {
                "vmName": {
                  "type": "string"
                },
                "location": {
                  "type": "string"
                },
                "AutoBackup": {
                  "type": "string"
                },
                "AutoPatch": {
                  "type": "string"
                },
                "Keyvaultupdate": {
                  "type": "string"
                },
                "sqlAutobackupRetentionPeriod": {
                    "type": "string",
                    "metadata": {
                      "description": "SQL Server Auto Backup Retention Period"
                    },
                    "allowedValues": [
                      "1",
                      "2",
                      "3",
                      "4",
                      "5",
                      "6",
                      "7",
                      "8",
                      "9",
                      "10",
                      "11",
                      "12",
                      "13",
                      "14",
                      "15",
                      "16",
                      "17",
                      "18",
                      "19",
                      "20",
                      "21",
                      "22",
                      "23",
                      "24",
                      "25",
                      "26",
                      "27",
                      "28",
                      "29",
                      "30"
                    ],
                    "defaultValue": "2"
                },
                "sqlAutobackupStorageAccountName": {
                    "type": "string",
                    "metadata": {
                      "description": "SQL Server Auto Backup Storage Account Name"
                    }
                },
                "sqlAutobackupEncryptionPassword": {
                    "type": "string",
                    "metadata": {
                      "description": "SQL Server Auto Backup Encryption Password"
                    }
                },
                "sqlAutopatchingDayOfWeek": {
                    "type": "string",
                    "metadata": {
                      "description": "SQL Server Auto Patching Day of A Week"
                    },
                    "allowedValues": [
                      "Everyday",
                      "Never",
                      "Sunday",
                      "Monday",
                      "Tuesday",
                      "Wednesday",
                      "Thursday",
                      "Friday",
                      "Saturday"
                    ],
                    "defaultValue": "Sunday"
                },
                "sqlAutopatchingStartHour": {
                    "type": "string",
                    "metadata": {
                      "description": "SQL Server Auto Patching Starting Hour"
                    },
                    "allowedValues": [
                      "0",
                      "1",
                      "2",
                      "3",
                      "4",
                      "5",
                      "6",
                      "7",
                      "8",
                      "9",
                      "10",
                      "11",
                      "12",
                      "13",
                      "14",
                      "15",
                      "16",
                      "17",
                      "18",
                      "19",
                      "20",
                      "21",
                      "22",
                      "23"
                    ],
                    "defaultValue": "2"
                },
                "sqlAutopatchingWindowDuration": {
                    "type": "string",
                    "metadata": {
                      "description": "SQL Server Auto Patching Duration Window in minutes"
                    },
                    "allowedValues": [
                      "30",
                      "60",
                      "90",
                      "120",
                      "150",
                      "180"
                    ],
                    "defaultValue": "60"
                },
                "sqlCredentialName": {
                    "type": "string",
                    "metadata": {
                      "description": "SQL credential name to create on the SQL Server virtual machine"
                    }
                },
                "sqlAkvUrl": {
                    "type": "string",
                    "metadata": {
                      "description": "Azure Key Vault URL"
                    }
                },
                "servicePrincipalName": {
                    "type": "string",
                    "metadata": {
                      "description": "Azure Key Vault principal name or id"
                    }
                },
                "servicePrincipalSecret": {
                    "type": "securestring",
                    "metadata": {
                      "description": "Azure Key Vault principal secret"
                    }
                }
              },
              "resources": [
                {
                  "condition": "[greater(length(parameters('AutoBackup')),0)]",
                  "name": "[concat(parameters('vmName'),'/SQLExpolicy')]",
                  "type": "Microsoft.Compute/virtualMachines/extensions",
                  "location": "[parameters('location')]",
                  "apiVersion": "2015-06-15",
                  "properties": {
                    "type": "SqlIaaSAgent",
                    "publisher": "Microsoft.SqlServer.Management",
                    "typeHandlerVersion": "1.2",
                    "autoUpgradeMinorVersion": "true",
                    "settings": {
                        "AutoBackupSettings": {
                          "Enable": true,
                          "RetentionPeriod": "[parameters('sqlAutobackupRetentionPeriod')]",
                          "EnableEncryption": true
                        }
                      },
                      "protectedSettings": {
                        "StorageUrl": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('sqlAutobackupStorageAccountName')), '2015-06-15').primaryEndpoints['blob']]",
                        "StorageAccessKey": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('sqlAutobackupStorageAccountName')), '2015-06-15').key1]",
                        "Password": "[parameters('sqlAutobackupEncryptionPassword')]"
                      }
                  }
                },
                {
                  "condition": "[greater(length(parameters('AutoPatch')),0)]",
                  "name": "[concat(parameters('vmName'),'/SQLExpolicy')]",
                  "type": "Microsoft.Compute/virtualMachines/extensions",
                  "location": "[parameters('location')]",
                  "apiVersion": "2015-06-15",
                  "properties": {
                    "type": "SqlIaaSAgent",
                    "publisher": "Microsoft.SqlServer.Management",
                    "typeHandlerVersion": "1.2",
                    "autoUpgradeMinorVersion": "true",
                    "settings": {
                        "AutoPatchingSettings": {
                            "PatchCategory": "WindowsMandatoryUpdates",
                            "Enable": true,
                            "DayOfWeek": "[parameters('sqlAutopatchingDayOfWeek')]",
                            "MaintenanceWindowStartingHour": "[parameters('sqlAutopatchingStartHour')]",
                            "MaintenanceWindowDuration": "[parameters('sqlAutopatchingWindowDuration')]"
                        }
                    }
                  }
                },
                {
                  "condition": "[greater(length(parameters('Keyvaultupdate')),0)]",
                  "name": "[concat(parameters('vmName'),'/SQLExpolicy')]",
                  "type": "Microsoft.Compute/virtualMachines/extensions",
                  "location": "[parameters('location')]",
                  "apiVersion": "2015-06-15",
                  "properties": {
                    "type": "SqlIaaSAgent",
                    "publisher": "Microsoft.SqlServer.Management",
                    "typeHandlerVersion": "1.2",
                    "autoUpgradeMinorVersion": "true",
                    "settings": {
                        "KeyVaultCredentialSettings": {
                          "Enable": true,
                          "CredentialName": "[parameters('sqlCredentialName')]"
                        }
                      },
                      "protectedSettings": {
                        "PrivateKeyVaultCredentialSettings": {
                          "AzureKeyVaultUrl": "[parameters('sqlAkvUrl')]",
                          "ServicePrincipalName": "[parameters('servicePrincipalName')]",
                          "ServicePrincipalSecret": "[parameters('servicePrincipalSecret')]"
                        }
                    }
                  }
                }
              ],
              "outputs": {
                "policy": {
                  "type": "string",
                  "value": "[concat('Enabled SQL Extension for Windows VM', ': ', parameters('vmName'))]"
                }
              }
            },
            "parameters": {
                "vmName": {
                    "value": "[field('name')]"
                },
                "location": {
                    "value": "[field('location')]"
                },
                "AutoBackup": {
                    "value": "[parameters('AutoBackup')]"
                },
                "AutoPatch": {
                    "value": "[parameters('AutoPatch')]"
                },
                "Keyvaultupdate": {
                    "value": "[parameters('Keyvaultupdate')]"
                },
                "sqlAutobackupRetentionPeriod": {
                    "value": "[parameters('sqlAutobackupRetentionPeriod')]"
                },
                "sqlAutobackupStorageAccountName": {
                    "value": "[parameters('sqlAutobackupStorageAccountName')]"
                },
                "sqlAutobackupEncryptionPassword": {
                    "value": "[parameters('sqlAutobackupEncryptionPassword')]"
                },
                "sqlAutopatchingDayOfWeek": {
                    "value": "[parameters('sqlAutopatchingDayOfWeek')]"
                },
                "sqlAutopatchingStartHour": {
                    "value": "[parameters('sqlAutopatchingStartHour')]"
                },
                "sqlAutopatchingWindowDuration": {
                    "value": "[parameters('sqlAutopatchingWindowDuration')]"
                },
                "sqlCredentialName": {
                    "value": "[parameters('sqlCredentialName')]"
                },
                "sqlAkvUrl": {
                    "value": "[parameters('sqlAkvUrl')]"
                },
                "servicePrincipalName": {
                    "value": "[parameters('servicePrincipalName')]"
                },
                "servicePrincipalSecret": {
                    "value": "[parameters('servicePrincipalSecret')]"
                }
            }
          }
        }
      }
    }
  }
